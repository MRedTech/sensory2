<!DOCTYPE html>
<html>
<head>
  <title>SECURE ENTRY SYSTEM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  body {
    font-family: Arial, sans-serif;
    background-color: #e9f5e9;
    padding: 20px;
    text-transform: uppercase;
  }
  h2 {
    color: #2b7a2b;
    text-align: center;
    margin-top: 0.10px;
    margin-bottom: 30px;
  }
  .clock-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    max-width: 180px;
    margin: 0 auto 13px auto;
    padding: 2.5px 12px;
    border-radius: 11px;
    background: linear-gradient(90deg, #41e671 0%, #176B39 100%);
    box-shadow: 0 1px 4px 0 #bbdfbb70;
    font-size: 11px;
    color: #fff;
    letter-spacing: 1.4px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    opacity: 0.90;
    position: relative;
    z-index: 10;
  }
  .clock-date, .clock-time {
    font-size: 11px;
  }
  .header-gradient {
    background: linear-gradient(145deg, #54e087 0%, #2b7a2b 100%);
    font-weight: 900;
    font-size: 1.8rem;
    letter-spacing: 1.3px;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    color: transparent;
  }
  .swal2-confirm {
    background: linear-gradient(135deg, #2b7a2b 0%, #3bd97b 100%) !important;
    color: #fff !important;
    font-weight: bold !important;
    border: none !important;
    border-radius: 12px !important;
    box-shadow: 0 3px 16px #bbdfbb9f, 0 1.5px 3px #3332 !important;
    letter-spacing: 1.5px;
    padding: 10px 32px;
    font-size: 1.07rem;
    transition: box-shadow 0.16s, transform 0.09s;
  }
  .swal2-confirm:active {
    box-shadow: 0 2px 5px #bbb !important;
    transform: translateY(2px);
  }
  .swal2-cancel {
    background: linear-gradient(135deg, #e52d27 0%, #ff5757 100%) !important;
    color: #fff !important;
    font-weight: bold !important;
    border: none !important;
    border-radius: 12px !important;
    box-shadow: 0 3px 12px #ffd2d2b9, 0 1.5px 3px #3332 !important;
    letter-spacing: 1.2px;
    padding: 10px 28px;
    font-size: 1.07rem;
    margin-left: 12px !important;
    transition: box-shadow 0.16s, transform 0.09s;
  }
  .swal2-cancel:active {
    box-shadow: 0 2px 6px #d8b !important;
    transform: translateY(2px);
  }

  /* ==== BUTANG ATAS & SUBMIT (COMPACT) ==== */
  .top-action {
    text-align: center;
    margin-bottom: 14px;
  }
  .btn-3d {
    background: linear-gradient(145deg, #3bd97b 0%, #2b7a2b 100%);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: bold;
    padding: 10px 22px;
    box-shadow: 0 3px 12px 0 #bbdfbb, 0 1.5px 3px #3333;
    letter-spacing: 1.6px;
    cursor: pointer;
    margin-bottom: 5px;
    transition: box-shadow 0.18s, transform 0.1s;
  }
  .btn-3d:active {
    box-shadow: 0 2px 5px #bbb;
    transform: translateY(2px);
  }
  .submit-3d {
    margin-top: 14px;
    width: 100%;
  }

  .photo-label {
    color: #2b7a2b;
    font-weight: bold;
    font-size: 13px;
    margin-top: 4px;
    margin-bottom: 3px;
    display: block;
  }

  .image-container {
    position: relative;
    display: none;
    margin-top: 10px;
    margin-bottom: 12px;
    width: 100%;
    max-height: 220px;
    overflow: hidden;
    background-color: #f0f0f0;
    border: 1px solid #2b7a2b;
    border-radius: 6px;
  }
  .image-container img {
    width: 100%;
    height: auto;
    object-fit: cover;
    transform-origin: center;
  }
  .watermark {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) rotate(-40deg);
    color: red;
    background: none;
    padding: 4px 20px;
    font-size: 14px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    border-radius: 4px;
    pointer-events: none;
    letter-spacing: 4px;
    opacity: 0.75;
    text-shadow: none;
    z-index: 9;
    white-space: nowrap;
  }

  /* ==== LABEL & INPUT ==== */
  label {
    display: block;
    margin-top: 10px;
    color: #2b7a2b;
    font-weight: bold;
    font-size: 13px;
  }
  input,
  select {
    width: 100%;
    padding: 7px 9px;
    margin-top: 4px;
    border: 1px solid #2b7a2b;
    border-radius: 8px;
    text-transform: uppercase;
    background-color: #e9f7ff;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
    font-size: 13px;
    font-weight: bold;
  }

  select:invalid,
  select option[value=""] {
    color: #888888 !important;
  }

  .reason-placeholder {
  color: #888888 !important;
  }
  #reasonSelect {
  color: #888888; 
  }
    
  .phone-container {
    position: relative;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
  }
  .phone-container input {
    flex: 1;
    margin-right: 6px;
  }
  .call-btn-3d {
    display: none;
    background: linear-gradient(145deg, #41e671 0%, #176B39 100%);
    color: #fff;
    border: none;
    border-radius: 100%;
    width: 50px;
    height: 50px;
    font-size: 17px;
    font-weight: bold;
    box-shadow: 0 3px 10px #8ed5a3, 0 1.5px 3px #3333;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: box-shadow 0.18s, transform 0.1s;
    position: relative;
    margin-left: 5px;
    outline: none;
    text-decoration: none;
  }
  .call-btn-3d span {
    font-size: 15px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    letter-spacing: 1.5px;
    color: #fff;
  }
  .call-btn-3d:active {
    box-shadow: 0 2px 5px #bbb;
    transform: translateY(2px) scale(0.98);
  }

  .footer {
    text-align: center;
    padding: 5px;
    font-size: 10px;
    color: #888888;
    margin-top: 24px;
    margin-bottom: 1px;
    font-family: Arial, sans-serif;
    font-weight: bold;
  }

  /* === MODAL KAMERA === */
  .camera-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.85);
    z-index: 99999;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  .camera-container {
    position: relative;
    width: 94vw;
    max-width: 400px;
    aspect-ratio: 4/3;
    background: #000;
    border-radius: 14px;
    overflow: hidden;
  }
  #camera-video {
    width: 100%;
    height: auto;
    border-radius: 14px;
    background: #222;
  }
  .guideline {
    position: absolute;
    border: 3px solid #28cc6c;
    border-radius: 8px;
    left: 4%;
    top: 4%;
    width: 92%;
    height: 92%;
    pointer-events: none;
    box-sizing: border-box;
  }
  .guideline.focus-google {
    border: 4px solid transparent !important;
    border-image: conic-gradient(
    #ea4335 0deg 90deg,   /* red */
    #fbbc05 90deg 180deg, /* yellow */
    #34a853 180deg 270deg,/* green */
    #4285f4 270deg 360deg /* blue */
    ) 1 !important;
  }
  .guideline.focus-wait {
    opacity: 0.95;
  }
  .close-cam-btn {
    position: absolute;
    top: 10px;
    right: 13px;
    z-index: 100;
    background: #fff;
    color: #1c7e41;
    border: none;
    border-radius: 24px;
    font-size: 21px;
    padding: 4px 13px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 10px #aaa;
  }
  .capture-btn-3d {
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(145deg, #41e671 0%, #176B39 100%);
    color: #fff;
    border: none;
    border-radius: 100%;
    width: 60px;
    height: 60px;
    font-size: 17px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    box-shadow: 0 3px 10px #8ed5a3, 0 1.5px 3px #3333;
    letter-spacing: 1.5px;
    cursor: pointer;
    transition: box-shadow 0.18s, transform 0.1s;
    margin-top: 16px;
  }
  .capture-btn-3d:active {
    box-shadow: 0 2px 5px #bbb;
    transform: translateY(2px) scale(0.98);
  }
  @media (max-width: 500px) {
    .camera-container { max-width: 98vw; }
  }
  .spinner,
  .loader {
    display: inline-block;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    box-sizing: border-box;
    /* ring putih + lutsinar macam loading Google */
    border: 3px solid rgba(255, 255, 255, 0.25);
    border-top-color: #ffffff;
    border-right-color: #ffffff;
    border-bottom-color: rgba(255, 255, 255, 0.1);
    border-left-color: rgba(255, 255, 255, 0.1);
    animation: google-spin 0.8s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }

  @keyframes google-spin {
    0%   { transform: rotate(0deg); }
    50%  { transform: rotate(180deg); }
    100% { transform: rotate(360deg); }
  }
  </style>
</head>
<body>
  <!-- TARIKH & MASA -->
  <div class="clock-bar">
    <span id="liveDateOnly"></span>
    <span id="liveTimeOnly"></span>
  </div>

  <div style="text-align:center;margin-bottom:8px;">
    <h2 class="header-gradient" style="margin-bottom:0.18em;">
      <span style="vertical-align:middle;"></span>
      SECURE ENTRY
    </h2>
    <div style="color:#489167;font-size:13px;letter-spacing:0.6px;margin-bottom:6px;">
      REGISTER.ACCESS.SECURE
    </div>
    <div style="height:3px;width:60px;margin:0 auto 4px auto;background:linear-gradient(90deg,#3bd97b 20%,#2b7a2b 80%);border-radius:2px;"></div>
  </div>

  <!-- === MINIMAL SEARCH RECORD === -->
  <div class="search-minicard">
    <div class="search-mini-title">
      <span class="search-emoji">ðŸ”Ž</span>
      <span>SEARCH RECORD</span>
    </div>

    <input id="searchUniversal" type="text" placeholder="MYKAD / PASSPORT / REG NO" autocomplete="off" class="search-mini-input" style="font-weight:bold;">
    <button id="searchButton" class="btn-3d search-mini-btn" type="button" onclick="handleUniversalSearch()">SEARCH</button>
  </div>

  <style>
  .search-minicard {
    max-width: 330px;
    margin: 18px auto 22px auto;
    background: #fff;
    border-radius: 13px;
    box-shadow: 0 2px 8px #176b3917;
    padding: 12px 15px 16px 15px;
  }
  .search-mini-title {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 9px;
    font-size: 15px;
    font-weight: bold;
    color: #176B39;
    letter-spacing: 1px;
  }
  .search-emoji {
    margin-right: 7px;
    font-size: 1.18em;
  }
  .search-mini-input {
    width: 100%;
    padding: 6.5px 10px;
    font-size: 14px;
    border-radius: 7px;
    border: 1.5px solid #176B39;
    margin-bottom: 9px;
    font-weight: 500;
    background: #e9f7ff;
    box-sizing: border-box;
    transition: border 0.15s;
  }
  .search-mini-input:focus {
    border: 1.6px solid #3bd97b;
    background: #f6fff6;
    outline: none;
  }
  .search-mini-btn {
    width: 100%;
    font-size: 16px;
    padding-top: 10px;
    padding-bottom: 10px;
    margin: 0 auto;
    box-sizing: border-box;
  }
  @media (max-width: 500px) {
    .search-minicard {
      max-width: 97vw;
      padding: 9px 4vw 12px 4vw;
    }
    .search-mini-title {
      font-size: 15px;
    }
    .search-mini-input {
      font-size: 13px;
      padding: 6px 7px;
    }
    .search-mini-btn {
      font-size: 13px;
      padding-top: 8px;
      padding-bottom: 8px;
    }
  }
  </style>

  <div class="top-action">
    <button type="button" id="takePhotoBtn" class="btn-3d" onclick="openCamera()">TAKE PICTURE</button>
    <span class="photo-label">Take photo of MyKad/Licence</span>
  </div>

  <div class="image-container" id="imageContainer">
    <img id="preview" src="#" alt="IMAGE PREVIEW">
    <div class="watermark">SENSORY USE ONLY</div>
  </div>

  <form id="registrationForm" autocomplete="off">
    <label for="namePassport">NAME</label>
    <input type="text" id="namePassport" name="namePassport" required>

    <label for="mykadPassport">MYKAD / PASSPORT</label>
    <input type="text" id="mykadPassport" name="mykadPassport" required>

    <script>
      const mykadInput = document.getElementById('mykadPassport');
      if (mykadInput) {
        mykadInput.addEventListener('input', function () {
          let val = this.value.toUpperCase();
          // Kalau semua nombor & panjang 12, auto-format dash
          if (/^\d{12}$/.test(val)) {
            this.value = val.replace(/(\d{6})(\d{2})(\d{4})/, "$1-$2-$3");
          } else {
            // Kalau bukan 12 digit (maksudnya mungkin passport, lesen, dsb), biar user taip asal (huruf/nombor)
            this.value = val.replace(/[^A-Z0-9]/g, '');
          }
        });
      }
    </script>

    <label for="regnum">REGISTRATION NUMBER</label>
    <input type="text" id="regnum" name="regnum" required>

    <label for="contact">CONTACT NUMBER</label>
    <div class="phone-container">
      <input type="tel" id="contact" name="contact" required oninput="updateCallLink()" maxlength="15" autocomplete="off" inputmode="numeric" pattern="[0-9]*">
      <a id="callBtn" class="call-btn-3d" title="Call this number" style="display:none;" target="_blank"><span>ðŸ“ž</span></a>
    </div>

    <label for="remark">CATEGORY</label>
    <select id="remark" name="remark" required>
      <option value="" disabled selected>-PLEASE SELECT-</option>
      <option value="DROP OFF/PICK UP">DROP OFF/PICK UP</option>
      <option value="DHL">DHL</option>
      <option value="E-HAILING">E-HAILING</option>
      <option value="FLASH EXPRESS">FLASH EXPRESS</option>
      <option value="FOOD PANDA">FOOD PANDA</option>
      <option value="GDEX">GDEX</option>
      <option value="GRAB FOOD">GRAB FOOD</option>
      <option value="J&T EXPRESS">J&T EXPRESS</option>
      <option value="LALAMOVE">LALAMOVE</option>
      <option value="LAZADA">LAZADA</option>
      <option value="MCD FOOD DELIVERY">MCD FOOD DELIVERY</option>
      <option value="NINJA VAN">NINJA VAN</option>
      <option value="OWNER">OWNER</option>
      <option value="POS LAJU">POS LAJU</option>
      <option value="SHOPEE EXPRESS">SHOPEE EXPRESS</option>
      <option value="SHOPEE FOOD">SHOPEE FOOD</option>
      <option value="TENANT">TENANT</option>
      <option value="OTHER">OTHER</option>
    </select>

    <input type="text" id="unitNumber" name="unitNumber" placeholder="UNIT NUMBER" style="display:none; margin-top:10px;" required>
    <input type="text" id="otherCategory" name="otherCategory" placeholder="PLEASE SPECIFY" style="display:none; margin-top:10px;" required> 

    <!-- Reason section (hidden by default) -->
    <div id="reasonSection" style="display:none; margin-top:10px;" required>
      <label for="reasonSelect">REASON</label>
      <select id="reasonSelect" name="reasonSelect">
        <option value="" disabled selected>-PLEASE SELECT-</option>
        <option value="Block card">Block card</option>
        <option value="Lost card">Lost card</option>
        <option value="Forget card">Forget card</option>
        <option value="Damaged card">Damaged card</option>
        <option value="Under management process">Under management process</option>
        <option value="Insufficient card">Insufficient card</option>
        <option value="Clone card">Clone card</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="reasonOther" name="reasonOther" placeholder="PLEASE SPECIFY" style="display:none; margin-top:7px;" required>
    </div>

    

    <label for="tower">TOWER</label>
    <select id="tower" name="tower" required>
      <option value="" disabled selected>-PLEASE SELECT-</option>
      <option value="TOWER A">TOWER A</option>
      <option value="TOWER B">TOWER B</option>
      <option value="TOWER A & B">TOWER A & B</option>
    </select>

    <input type="file" accept="image/*" capture="environment" id="imageInput" style="display:none;">

    <!-- BUTTON SUBMIT (dlm form utama) -->
    <button type="submit" class="btn-3d submit-3d" id="submitBtn">SUBMIT</button>
  </form>

  <div class="footer">POWERED BY MRED TECH</div>

  <!-- === MODAL KAMERA UNTUK GUIDELINE === -->
  <div id="cameraModal" class="camera-modal" style="display:none;">
    <div class="camera-container">
      <video id="camera-video" autoplay playsinline></video>
      <div class="guideline"></div>
      <button class="close-cam-btn" type="button" onclick="closeCameraModal()">Ã—</button>
    </div>
    <button class="capture-btn-3d" type="button" onclick="captureImage()"></button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // --- MODAL CAMERA + GUIDELINE & AUTO-CROP ---
    let stream = null;
    let video  = null;

    // ===== BEEP SOUND =====
    let _beepCtx = null;

    function playBeep() {
  try {
    if (!_beepCtx) return;

    const oscillator = _beepCtx.createOscillator();
    const gainNode = _beepCtx.createGain();

    oscillator.type = "sine";
    oscillator.frequency.value = 1200; // pitch
    gainNode.gain.value = 0.15;        // volume

    oscillator.connect(gainNode);
    gainNode.connect(_beepCtx.destination);

    oscillator.start();
    setTimeout(() => oscillator.stop(), 120);
  } catch (e) {
    console.log("Beep error:", e);
  }
    }
    
    // ===== AUDIO UNLOCK (wajib utk beep auto) =====
    function unlockAudioOnce() {
  if (_beepCtx) return;

  try {
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    _beepCtx = new AudioCtx();

    // silent tick (unlock audio on mobile)
    const o = _beepCtx.createOscillator();
    const g = _beepCtx.createGain();
    g.gain.value = 0.0001;

    o.connect(g);
    g.connect(_beepCtx.destination);

    o.start();
    o.stop(_beepCtx.currentTime + 0.02);
  } catch (e) {
    console.log("Audio unlock fail:", e);
  }
    }

// Unlock audio pada first tap/click user
window.addEventListener("pointerdown", unlockAudioOnce, { once: true });

    // ===== FOCUS DETECT + AUTO SNAP =====
let focusAutoTimer = null;
let autoSnapDone = false;
let sharpStable = 0;

let _prevFrameGray = null;
let _roi = null;

function analyzeFrame(video) {
  const w = 160, h = 120;
  const c = document.createElement("canvas");
  c.width = w; c.height = h;
  const ctx = c.getContext("2d", { willReadFrequently: true });

  const vw = video.videoWidth || 0;
  const vh = video.videoHeight || 0;

  // kalau video belum ready, return nilai "fail"
  if (!vw || !vh) {
    return { sharpness: 0, edgeDensity: 0, motion: 999, gray: new Uint8ClampedArray(w*h), w, h };
  }

  // crop ikut ROI guideline (kalau ada)
  if (_roi) {
    const sx = Math.max(0, Math.floor(vw * _roi.rx));
    const sy = Math.max(0, Math.floor(vh * _roi.ry));
    const sw = Math.max(1, Math.floor(vw * _roi.rw));
    const sh = Math.max(1, Math.floor(vh * _roi.rh));
    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
  } else {
    // fallback: full frame
    ctx.drawImage(video, 0, 0, w, h);
  }

  const data = ctx.getImageData(0, 0, w, h).data;

  // grayscale
  const gray = new Uint8ClampedArray(w * h);
  for (let i = 0, p = 0; i < data.length; i += 4, p++) {
    gray[p] = (0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]) | 0;
  }
  
  // --- sharpness (variance of laplacian) + edge density ---
  let sum = 0, sumSq = 0, n = 0;
  let edgeCount = 0;

  for (let y = 1; y < h - 1; y++) {
  for (let x = 1; x < w - 1; x++) {
    const i = y * w + x;
    const lap =
      -4 * gray[i] +
      gray[i - 1] + gray[i + 1] +
      gray[i - w] + gray[i + w];

    sum += lap;
    sumSq += lap * lap;
    n++;

    if (Math.abs(lap) > 22) edgeCount++;
   }
  }
  
  const mean = sum / n;
  const sharpness = (sumSq / n) - (mean * mean);
  const edgeDensity = edgeCount / n; // 0..1

  // --- motion score (perubahan frame) ---
  let motion = 999;
  if (_prevFrameGray) {
    let diff = 0;
    for (let i = 0; i < gray.length; i += 3) {
      diff += Math.abs(gray[i] - _prevFrameGray[i]);
    }
    motion = diff / (gray.length / 3);
  }
  _prevFrameGray = gray;

  return { sharpness, edgeDensity, motion, gray, w, h };
}

    // hasTextLike
  function hasTextLike(gray, w, h) {
  let dark = 0, total = 0;
  const T = 130; 

  for (let y = 0; y < h; y += 2) {
    for (let x = 0; x < w; x += 2) {
      const v = gray[y * w + x];
      total++;
      if (v < T) dark++;
    }
  }

  const ratio = dark / total;

  // mesti ada "ink" sederhana â†’ text
  return ratio >= 0.045 && ratio <= 0.45;
  }
    
    function startFocusAutoSnap() {
  stopFocusAutoSnap();
  autoSnapDone = false;
  sharpStable = 0;

  // reset baseline motion setiap kali buka kamera
  _prevFrameGray = null;
  const startTime = Date.now();

  const guideline = document.querySelector(".guideline");
  if (guideline) {
    guideline.classList.remove("focus-google");
    guideline.classList.add("focus-wait");
  }
 
  // --- ROI ikut guideline (supaya background noisy tak ganggu) ---
try {
  const container = document.querySelector(".camera-container");
  if (container && guideline) {
    const gr = guideline.getBoundingClientRect();
    const cr = container.getBoundingClientRect();

    _roi = {
      rx: (gr.left - cr.left) / cr.width,
      ry: (gr.top - cr.top) / cr.height,
      rw: gr.width / cr.width,
      rh: gr.height / cr.height
    };
  } else {
    _roi = null;
  }
} catch (e) {
  _roi = null;
}

  // ===== SETTINGS (lebih ketat, tak snap kalau tiada ID) =====
  const MIN_WAIT_MS  = 600;   // tunggu kamera stabil dulu
  const SHARP_THRESH = 260;   // ketajaman minimum
  const EDGE_MIN     = 0.055; // mesti ada text/garis (ID)
  const MOTION_MAX   = 7.5;   // mesti stabil (kurang gegar)
  const NEED_STABLE  = 2;     // berapa frame berturut-turut

  focusAutoTimer = setInterval(() => {
    if (!video || autoSnapDone) return;

    // tunggu sekejap selepas camera open (elak snap kosong)
    if (Date.now() - startTime < MIN_WAIT_MS) return;

    const { sharpness, edgeDensity, motion, gray, w, h } = analyzeFrame(video);
    const textOk = hasTextLike(gray, w, h);

    const ok =
  textOk &&
  sharpness >= SHARP_THRESH &&
  edgeDensity >= EDGE_MIN &&
  motion <= MOTION_MAX;
    
    sharpStable = ok ? (sharpStable + 1) : 0;

    if (sharpStable >= NEED_STABLE) {
      autoSnapDone = true;

      if (guideline) {
        guideline.classList.add("focus-google");
        guideline.classList.remove("focus-wait");
      }

      // pastikan beep boleh bunyi di mobile
      unlockAudioOnce();
      playBeep();

      setTimeout(() => {
        captureImage(); // crop+OCR kekal guna function sedia ada
      }, 220);
    }
  }, 220);
}

function stopFocusAutoSnap() {
  if (focusAutoTimer) clearInterval(focusAutoTimer);
  focusAutoTimer = null;
}
    
    function openCamera() {
      document.getElementById('cameraModal').style.display = 'flex';
      startCamera();
    }

    async function startCamera() {
      video = document.getElementById('camera-video');
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
      startFocusAutoSnap();
    };
      } catch (e) {
        alert("Failed to open camera: " + e.message);
        closeCameraModal();
      }
    }

    function closeCameraModal() {
      stopFocusAutoSnap();
      document.getElementById('cameraModal').style.display = 'none';
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    // === MODE A: GRAYSCALE + CONTRAST ENHANCEMENT ===
    function applyGrayscaleContrast(canvas) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;

      let minL = 255;
      let maxL = 0;

      for (let i = 0; i < data.length; i += 4) {
        const r   = data[i];
        const g   = data[i + 1];
        const b   = data[i + 2];
        const lum = 0.299 * r + 0.587 * g + 0.114 * b;

        if (lum < minL) minL = lum;
        if (lum > maxL) maxL = lum;

        data[i] = data[i + 1] = data[i + 2] = lum;
      }

      const range = Math.max(1, maxL - minL);

      for (let i = 0; i < data.length; i += 4) {
        let lum       = data[i];
        let stretched = ((lum - minL) * 255) / range;
        stretched     = Math.max(0, Math.min(255, stretched));
        data[i] = data[i + 1] = data[i + 2] = stretched;
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // Capture image AI
    function captureImage() {
      stopFocusAutoSnap();
      if (!video) return;

      const container = document.querySelector('.camera-container');
      const guideline = document.querySelector('.guideline');
      const rect      = guideline.getBoundingClientRect();
      const contRect  = container.getBoundingClientRect();

      const ratioLeft   = (rect.left - contRect.left) / contRect.width;
      const ratioTop    = (rect.top - contRect.top) / contRect.height;
      const ratioWidth  = rect.width  / contRect.width;
      const ratioHeight = rect.height / contRect.height;

      const canvas = document.createElement('canvas');
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const cropX = canvas.width  * ratioLeft;
      const cropY = canvas.height * ratioTop;
      const cropW = canvas.width  * ratioWidth;
      const cropH = canvas.height * ratioHeight;

      const cropCanvas = document.createElement('canvas');
      cropCanvas.width  = cropW;
      cropCanvas.height = cropH;
      cropCanvas.getContext('2d').drawImage(
        canvas, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH
      );

      applyGrayscaleContrast(cropCanvas);
      const compressed = cropCanvas.toDataURL('image/jpeg', 0.85);

      document.getElementById('preview').src = compressed;
      document.getElementById('imageContainer').style.display = 'block';

      closeCameraModal();

      // Hantar ke Google Vision utk autofill
      (async () => {
        try {
          document.body.style.cursor = 'progress';
          const proxyUrl = "https://sensory-vision.edreborn86.workers.dev";
          const res      = await fetch(proxyUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: compressed.split(",")[1] })
          });
          const result = await res.json();
          document.body.style.cursor = 'default';

          if (result.name) {
            const rawName   = result.name.toUpperCase().trim();
            const cleanName = filterNonNameWords(rawName);
            document.getElementById('namePassport').value = cleanName;
          }
          if (result.idnum) {
            document.getElementById('mykadPassport').value = result.idnum.toUpperCase();
          }

        } catch (err) {
          document.body.style.cursor = 'default';
          alert("Autofill GAGAL: " + err.message);
        }
      })();
    }

    // Fallback: gambar dari GALLERY (crop + grayscale)
document.getElementById('imageInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function() {
    const img = new window.Image();
    img.onload = async function() {

      // 1. Resize maksimum lebar 800
      const baseCanvas = document.createElement('canvas');
      const scale      = Math.min(1, 800 / img.width);
      baseCanvas.width  = img.width  * scale;
      baseCanvas.height = img.height * scale;
      const bctx = baseCanvas.getContext('2d');
      bctx.drawImage(img, 0, 0, baseCanvas.width, baseCanvas.height);

      // 2. CROP BAHAGIAN TENGAH (contoh: 60% tinggi)
      const cropCanvas = document.createElement('canvas');
      const cropW = baseCanvas.width;          // penuh lebar
      const cropH = baseCanvas.height * 0.6;   // ambil 60% tengah
      const cropX = 0;
      const cropY = (baseCanvas.height - cropH) / 2;

      cropCanvas.width  = cropW;
      cropCanvas.height = cropH;
      const cctx = cropCanvas.getContext('2d');
      cctx.drawImage(
        baseCanvas,
        cropX, cropY, cropW, cropH,
        0, 0, cropW, cropH
      );

      // 3. Grayscale + contrast pada gambar yang sudah crop
      applyGrayscaleContrast(cropCanvas);

      // 4. Jadikan JPEG base64 & preview
      const compressed = cropCanvas.toDataURL('image/jpeg', 0.85);
      const preview    = document.getElementById('preview');
      preview.src      = compressed;
      document.getElementById('imageContainer').style.display = 'block';

      // 5. Hantar ke Google Vision (guna versi cropped)
      try {
        const proxyUrl = "https://sensory-vision.edreborn86.workers.dev";
        document.body.style.cursor = 'progress';
        const res = await fetch(proxyUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: compressed.split(",")[1] })
        });
        const result = await res.json();
        document.body.style.cursor = 'default';

        if (result.name) {
          const rawName   = result.name.toUpperCase().trim();
          const cleanName = filterNonNameWords(rawName);
          document.getElementById('namePassport').value = cleanName;
        }
        if (result.idnum) {
          document.getElementById('mykadPassport').value = result.idnum.toUpperCase();
        }
      } catch (err) {
        document.body.style.cursor = 'default';
        alert("Autofill GAGAL: " + err.message);
      }
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
});

  // === CROP GAMBAR MENGIKUT APA YANG NAMPAK DALAM PREVIEW ===
  function getVisibleCroppedImageData() {
    const img = document.getElementById('preview');
    const container = document.getElementById('imageContainer');

    if (!img || !img.src || img.src === "#" || !img.src.startsWith("data:image")) {
      return img ? img.src : "";
    }

    const naturalWidth  = img.naturalWidth;
    const naturalHeight = img.naturalHeight;
    const visibleWidth  = container.clientWidth;
    const visibleHeight = container.clientHeight;

    if (!naturalWidth || !naturalHeight || !visibleWidth || !visibleHeight) {
      return img.src;
    }

    // Imej discale ikut lebar container
    const scale = visibleWidth / naturalWidth;
    const scaledHeight = naturalHeight * scale;

    // Tinggi sebenar yang nampak dalam container
    const displayHeight = Math.min(visibleHeight, scaledHeight);

    // Convert semula ke koordinat asal (natural) imej
    const srcVisibleHeight = displayHeight / scale;

    const canvas = document.createElement('canvas');
    canvas.width  = naturalWidth;
    canvas.height = srcVisibleHeight;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(
      img,
      0, 0, naturalWidth, srcVisibleHeight,
      0, 0, naturalWidth, srcVisibleHeight
    );

    return canvas.toDataURL('image/jpeg', 0.9);
  }

  // === AUTO DETECT DEVICE & SET PREVIEW HEIGHT (A) ===
function adjustPreviewSize() {
  const container = document.getElementById('imageContainer');
  if (!container) return;

  // Lebar sebenar container di skrin
  const width =
    container.clientWidth ||
    window.innerWidth ||
    document.documentElement.clientWidth;

  // Anggaran nisbah tinggi:lebar untuk kad
  const targetRatio = 0.7;
  const maxHeightPx = Math.round(width * targetRatio);

  // Set max-height ikut lebar (auto scale phone / tablet / iPad)
  container.style.maxHeight = maxHeightPx + "px";
}

window.addEventListener('load', adjustPreviewSize);
window.addEventListener('resize', adjustPreviewSize);
  

    // Butang CALL
    function updateCallLink() {
      const phone   = document.getElementById('contact').value.trim();
      const callBtn = document.getElementById('callBtn');
      if (phone.length >= 10) {
        callBtn.href = 'tel:' + phone;
        callBtn.style.display = 'flex';
      } else {
        callBtn.style.display = 'none';
      }
    }
    document.getElementById('callBtn').addEventListener('click', function(e) {
      const phone = document.getElementById('contact').value.trim();
      if (phone.length < 10) e.preventDefault();
    });

    // === CATEGORY, UNIT NUMBER & REASON DROPDOWN ===
const remarkSelect  = document.getElementById('remark');
const otherField    = document.getElementById('otherCategory');
const unitField     = document.getElementById('unitNumber');
const reasonSection = document.getElementById('reasonSection');
const reasonSelect  = document.getElementById('reasonSelect');
const reasonOther   = document.getElementById('reasonOther');

// pastikan mula-mula tidak required
unitField.required = false;
otherField.required = false;
reasonSelect.required = false;
reasonOther.required = false;

remarkSelect.addEventListener('change', function() {
  const val = this.value.toUpperCase();
  const isResident = (val === 'OWNER' || val === 'TENANT');

  // OWNER / TENANT â†’ show UNIT & REASON
  unitField.style.display     = isResident ? 'block' : 'none';
  reasonSection.style.display = isResident ? 'block' : 'none';

  unitField.required    = isResident;
  reasonSelect.required = isResident;

  if (!isResident) {
    unitField.value = "";
    reasonSelect.value = "";
    reasonSelect.style.color = '#888';
    reasonOther.style.display = 'none';
    reasonOther.required = false;
    reasonOther.value = "";
  }

  // CATEGORY = OTHER â†’ show Other Category
  const isOtherCat = (val === 'OTHER');
  otherField.style.display = isOtherCat ? 'block' : 'none';
  otherField.required = isOtherCat;

  if (!isOtherCat) {
    otherField.value = "";
    otherField.required = false;
  }
});

// Reason dropdown - show Other Reason + Clone Card style
reasonSelect.addEventListener('change', function() {
  const val = this.value;

  // Other Reason
  if (val === 'Other') {
    reasonOther.style.display = 'block';
    reasonOther.required = true;
  } else {
    reasonOther.style.display = 'none';
    reasonOther.value = '';
    reasonOther.required = false;
  }

  // Clone card merah
  if (val.toUpperCase() === 'CLONE CARD') {
    this.style.color = 'red';
    this.style.fontWeight = 'bold';
  } else if (val === '') {
    this.style.color = '#888888';
    this.style.fontWeight = 'bold';
  } else {
    this.style.color = '#000';
    this.style.fontWeight = 'bold';
  }
});
    
    /*// === VALIDASI SUBMIT (WARNING) ===
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
      const remark         = remarkSelect.value.toUpperCase();
      const other          = otherField.value.trim();
      const unit           = unitField.value.trim();
      const reason         = reasonSelect.value;
      const reasonOtherVal = reasonOther.value.trim();

      // OTHER -> wajib isi OTHER CATEGORY
      if (remark === 'OTHER' && other === '') {
        e.preventDefault();
        e.stopImmediatePropagation();
        safeSwalFire({
          title: 'MISSING INFORMATION',
          text: 'Please specify OTHER CATEGORY.',
          icon: 'warning',
          confirmButtonText: 'OK'
        });
        return;
      }

      // OWNER/TENANT -> wajib unit number
      if ((remark === 'OWNER' || remark === 'TENANT') && unit === '') {
        e.preventDefault();
        e.stopImmediatePropagation();
        safeSwalFire({
          title: 'MISSING INFORMATION',
          text: 'Please enter UNIT NUMBER.',
          icon: 'warning',
          confirmButtonText: 'OK'
        });
        return;
      }

      // OWNER/TENANT -> wajib pilih reason
      if ((remark === 'OWNER' || remark === 'TENANT') && reason === '') {
        e.preventDefault();
        e.stopImmediatePropagation();
        safeSwalFire({
          title: 'MISSING INFORMATION',
          text: 'Please select REASON.',
          icon: 'warning',
          confirmButtonText: 'OK'
        });
        return;
      }

      // OWNER/TENANT + REASON = Other -> wajib isi other reason
      if ((remark === 'OWNER' || remark === 'TENANT') && reason === 'Other' && reasonOtherVal === '') {
        e.preventDefault();
        e.stopImmediatePropagation();
        safeSwalFire({
          title: 'MISSING INFORMATION',
          text: 'Please specify OTHER REASON.',
          icon: 'warning',
          confirmButtonText: 'OK'
        });
        return;
      }
    });*/

    // Auto format UNIT NUMBER
    document.getElementById('unitNumber').addEventListener('input', function() {
      let raw = this.value.toUpperCase();
      raw = raw.replace(/[^A-Z0-9]/g, '');
      if (raw.length > 1 && raw[1] !== '-') {
        raw = raw[0] + '-' + raw.slice(1);
      }
      let val = raw.replace(/-/g, '');

      let mG = val.match(/^([A-Z])G(\d{1,2}[A-Z]?)(\d{0,2}[A-Z]?)$/);
      if (mG && val.length > 2) {
        let out = mG[1] + '-G-' + mG[2];
        if (mG[3]) out += '-' + mG[3];
        this.value = out;
        return;
      }
      if (val.length > 4 && val[3] === "A" && val[4] !== "-") {
        this.value = raw.slice(0, 5) + "-" + raw.slice(5);
        return;
      }
      let mStd = val.match(/^([A-Z])(\d{2})(\d{1,2}[A-Z]?)$/);
      if (mStd) {
        this.value = mStd[1] + '-' + mStd[2] + '-' + mStd[3];
        return;
      }
      let mShort = val.match(/^([A-Z])(\d{2}[A-Z])$/);
      if (mShort) {
        this.value = mShort[1] + '-' + mShort[2];
        return;
      }
      let m1 = val.match(/^([A-Z])(\d)$/);
      if (m1) {
        this.value = m1[1] + '-' + m1[2];
        return;
      }
      let mAG = val.match(/^([A-Z])G$/);
      if (mAG) {
        this.value = mAG[1] + '-G';
        return;
      }
      if (/^[A-Z](-[G]?)?(-?\d{1,2}[A-Z]?)*(-\d{1,2}[A-Z]?)?$/.test(this.value)) {
        return;
      }
      this.value = val.replace(/^([A-Z])G/, "$1-G");
    });

    // ---- ANIMASI BUTTON SUBMIT ----
    function setSubmitBtnLoading(isLoading) {
      const btn = document.getElementById('submitBtn');
      if (!btn) return;
      if (isLoading) {
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span>SUBMITTING...`;
      } else {
        btn.disabled = false;
        btn.innerHTML = `SUBMIT`;
      }
    }
    
    // ---- SAFE SWAL (fallback) ----
    function safeSwalFire(options) {
      if (typeof Swal !== "undefined") return Swal.fire(options);
      alert((options.title || "NOTICE") + "\n\n" + (options.text || ""));
      return Promise.resolve({ isConfirmed: true });
    }

    // ==== AI Smart OCR Verification helper ====
    function isMyKadPattern(ic) {
      return /^(\d{6}-?\d{2}-?\d{4})$/.test(ic) || /^(\d{12})$/.test(ic);
    }
    function isLesenPattern(lesen) {
      return /^[A-Z]\d{8,9}$/.test(lesen);
    }
    function isPassportPattern(passport) {
      return /^[A-Z]{1,2}\d{6,9}$/.test(passport);
    }
    function isValidName(name) {
      return (name && name.length >= 5 && /^[A-Z \-']+$/i.test(name));
    }

    const NON_NAME_WORDS = [
      "MALAYSIA", "MALAYSIA P", "KAD PENGENALAN", "IDENTITY CARD", "MYKAD", "ID", "PASSPORT",
      "WARGANEGARA", "LELAKI", "PEREMPUAN", "ISLAM", "CHRISTIAN", "BUDDHA", "HINDU",
      "AGAMA", "MALE", "FEMALE", "JANTINA", "NATIONALITY", "CITIZENSHIP", "LICENCE",
      "LESEN MEMANDU", "DRIVING LICENCE", "VOCATIONAL LICENCE", "DIGITAL", "GOVERNMENT", "CLASS",
      "NO. K/P", "KELAS", "NO. KAD PENGENALAN", "NO. ID", "NO KP", "NO IC", "D.O.B", "TARIKH LAHIR",
      "SEX", "JANTINA", "EXPIRY", "EXP", "VALID", "VALIDITY", "TARIKH", "ADDRESS", "ALAMAT"
    ];

    function filterNonNameWords(text) {
      let words    = text.split(/\s+/);
      let filtered = words.filter(word => {
        return !NON_NAME_WORDS.includes(word.toUpperCase());
      });
      return filtered.join(' ');
    }

    // ---- UNIVERSAL SEARCH ----
    const WORKER_URL = "https://ext-mredtech.edreborn86.workers.dev";
    
document.addEventListener("DOMContentLoaded", () => {
  if (!sessionStorage.getItem("SE_WARMED")) {
    fetch(WORKER_URL + "?debug=1", { cache: "no-store" }).catch(() => {});
    sessionStorage.setItem("SE_WARMED", "1");
  }
});
    
    // === STANDARD FIELD NAME (API CONTRACT) ===
    const FIELD = {
     REG: "REGNUM",
     ID: "MYKADPASSPORT"
  };
    
    function normalize(str) {
      return (str || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
    }

    function detectSearchField(raw) {
  const s = (raw || "").trim().toUpperCase();

  const digitsOnly = s.replace(/[^0-9]/g, "");
  const alnumOnly  = s.replace(/[^A-Z0-9]/g, "");

  // 1) MyKad: 12 digit atau format dash
  if (digitsOnly.length === 12) return FIELD.ID;
  if (/^\d{6}-\d{2}-\d{4}$/.test(s)) return FIELD.ID;

  // 2) Passport: huruf depan + digit sahaja
  if (/^[A-Z]{1,3}\d{5,}$/.test(alnumOnly)) return FIELD.ID;

  // 3) Reg num Malaysia: biasa ada 1-3 huruf + digit
  if (/^[A-Z]{1,3}\d/.test(alnumOnly)) return FIELD.REG;

  // Default â†’ fallback universal
  return "";
    }
    
    async function searchRecord(field, value) {
      const url = `${WORKER_URL}?field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}`;
      const res = await fetch(url);
      return await res.json();
    }

    async function handleUniversalSearch() {
  const btn = document.getElementById('searchButton');
  const inputEl = document.getElementById('searchUniversal');

  const input = (inputEl?.value || '').trim();
  if (!input) return;

  // simpan input asal untuk auto-isi regnum kalau NOT FOUND / EXPIRED
  const originalInput = input;

  // normalized untuk query (uppercase + buang simbol)
  const valueNorm = normalize(input);

  // detect field supaya kalau jelas â†’ 1 call sahaja (boost speed)
  const detectedField = detectSearchField(input);

  btn.disabled = true;
  btn.innerHTML = '<span class="loader"></span> SEARCHING...';

  try {
    let found = null;
    let hasHyperlink = false;
    let res;

    // =========================
    // 1) Jika jelas REGNUM / ID â†’ 1 carian sahaja
    // =========================
    if (detectedField) {
      res = await searchRecord(detectedField, valueNorm);

      if (res && res.exist) {
        found = res.data || null;
        hasHyperlink = res.hasHyperlink ?? false;
      }
    }

    // =========================
    // 2) Kalau tak pasti â†’ fallback universal (REG dulu, then ID)
    // =========================
    if (!found && !detectedField) {
      res = await searchRecord(FIELD.REG, valueNorm);
      if (res && res.exist) {
        found = res.data || null;
        hasHyperlink = res.hasHyperlink ?? false;
      }

      if (!found) {
        res = await searchRecord(FIELD.ID, valueNorm);
        if (res && res.exist) {
          found = res.data || null;
          hasHyperlink = res.hasHyperlink ?? false;
        }
      }
    }

    // =========================
    // 3) FOUND tapi tiada hyperlink = EXPIRED â†’ retake ID
    // =========================
    if (found && !hasHyperlink) {
      safeSwalFire({
        title: 'PREVIOUS RECORD EXPIRED',
        text: 'Please retake id photo',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'YES, RETAKE ID',
        cancelButtonText: 'NO',
        background: 'linear-gradient(135deg, #fff9e6 0%, #ffecb3 45%, #ffd54f 100%)',
        color: '#176B39',
        width: 300,
        customClass: { popup: 'shadow-2xl px-7 pt-7 pb-6' },
        willOpen: popup => { popup.style.borderRadius = "14px"; }
      }).then((r) => {
        // clear input search
        inputEl.value = "";

        if (r.isConfirmed) {
          // auto isi regnum dalam form jika kosong
          const regField = document.getElementById('regnum');
          if (regField && !regField.value) {
            regField.value = originalInput.toUpperCase();
          }

          // scroll ke form
          const formEl = document.getElementById('registrationForm');
          if (formEl) {
            formEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }

          // buka kamera selepas OK
          openCamera();
        }
      });

      return;
    }

    // =========================
    // 4) FOUND + hyperlink â†’ tanya nak autofill
    // =========================
    if (found) {
      safeSwalFire({
        title: 'RECORD FOUND',
        text: 'Autofill this form with record details?',
        icon: 'success',
        showCancelButton: true,
        confirmButtonText: 'YES, AUTOFILL',
        cancelButtonText: 'NO',
        background: 'linear-gradient(135deg, #e9f7ef 0%, #c8efd9 45%, #9fdfbf 100%)',
        color: '#176B39',
        width: 300,
        customClass: { popup: 'shadow-2xl px-7 pt-7 pb-6' },
        willOpen: popup => { popup.style.borderRadius = "14px"; }
      }).then((r) => {
        if (r.isConfirmed) {
          try {
            autofillForm(found);
          } catch (e) {
            console.error("autofillForm error:", e);
          }

          const formEl = document.getElementById('registrationForm');
          if (formEl) {
            formEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }

        // clear input search
        inputEl.value = "";
      });

      return;
    }

    // =========================
    // 5) NOT FOUND â†’ proceed register + auto isi regnum + open camera
    // =========================
    safeSwalFire({
      title: 'NO PREVIOUS RECORD',
      text: 'Please proceed to register',
      icon: 'warning',
      confirmButtonText: 'OK',
      background: 'linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 45%, #81d4fa 100%)',
      color: '#176B39',
      width: 300,
      customClass: { popup: 'shadow-2xl px-7 pt-7 pb-6' },
      willOpen: popup => { popup.style.borderRadius = "14px"; }
    }).then(() => {
      // clear input search
      inputEl.value = "";

      // auto isi regnum dalam form jika kosong
      const regField = document.getElementById('regnum');
      if (regField && !regField.value) {
        regField.value = originalInput.toUpperCase();
      }

      // scroll ke form
      const formEl = document.getElementById('registrationForm');
      if (formEl) {
        formEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      // buka kamera
      openCamera();
    });

  } catch (err) {
    console.error(err);
    safeSwalFire({
      title: 'ERROR',
      text: err?.message || 'Search failed!',
      icon: 'error',
      confirmButtonText: 'OK'
    });
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'SEARCH';
  }
    }
    
    function autofillForm(data) {
      if (data.namePassport)   document.getElementById('namePassport').value   = data.namePassport;
      if (data.mykadPassport)  document.getElementById('mykadPassport').value  = data.mykadPassport;
      if (data.regnum)         document.getElementById('regnum').value         = data.regnum;
      if (data.contact)        document.getElementById('contact').value        = data.contact;

      if (data.remark) {
        let match = data.remark.match(/^(OWNER|TENANT)/i);
        if (match) {
          document.getElementById('remark').value = match[1];
          document.getElementById('remark').dispatchEvent(new Event('change'));
          let unitMatch = data.remark.match(/\(\s*([^)]+)\s*\)/);
          if (unitMatch) document.getElementById('unitNumber').value = unitMatch[1];
        } else {
          document.getElementById('remark').value = data.remark;
          document.getElementById('unitNumber').value = "";
        }
      }

      /*if (data.tower) document.getElementById('tower').value = data.tower;*/
    }

    // Trigger search bila blur MYKAD/PASSPORT
    document.getElementById('mykadPassport').addEventListener('blur', async function() {
      const value = this.value.trim();
      if (value.length < 6) return;
      const result = await searchRecord(FIELD.ID, normalize(value));
      if (result.exist) {
        safeSwalFire({
          title: 'PREVIOUS DATA FOUND',
          text: 'Autofill with existing details?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'YES, AUTOFILL',
          cancelButtonText: 'NO',
          background: 'linear-gradient(135deg,#e9f5e9,#fff,#d5ffe0)',
          color: '#176B39',
          width: 300,
          customClass: { popup: 'shadow-2xl px-7 pt-7 pb-6' },
          willOpen: (popup) => { popup.style.borderRadius = '14px'; }
        }).then((res) => {
          if (res.isConfirmed) {
            autofillForm(result.data);
          }
        });
      }
    });

    // Endpoint Cloudflare Worker
    const urlCloudflareWorker = "https://ext-mredtech.edreborn86.workers.dev";

    // Submit ke Worker
    document.getElementById("registrationForm").addEventListener("submit", async function(e){
  e.preventDefault();
      
    setSubmitBtnLoading(true);  

  // ambil gambar yang sudah di-crop ikut apa yang nampak dalam preview
  const croppedImage = getVisibleCroppedImageData();

  // --- Format data sebelum submit ---
let remarkValue = document.getElementById('remark').value;
let otherCategoryVal = document.getElementById('otherCategory').value.trim();
let unitNumberVal = document.getElementById('unitNumber').value.trim();
let reasonVal = document.getElementById('reasonSelect').value;
let reasonOtherVal = document.getElementById('reasonOther').value.trim();

// === FORMAT CATEGORY ===
if (remarkValue === "OTHER" && otherCategoryVal) {
  remarkValue = `OTHER ( ${otherCategoryVal} )`;
} else if ((remarkValue === "OWNER" || remarkValue === "TENANT") && unitNumberVal) {
  remarkValue = `${remarkValue} ( ${unitNumberVal} )`;
}

// === FORMAT REASON ===
let reasonFinal = "";
if ((remarkValue.includes("OWNER") || remarkValue.includes("TENANT")) && reasonVal) {
  if (reasonVal === "Other" && reasonOtherVal) {
    reasonFinal = `OTHER ( ${reasonOtherVal} )`;
  } else {
    reasonFinal = reasonVal.toUpperCase();
  }
}

const data = {
  namePassport: document.getElementById('namePassport').value,
  mykadPassport: document.getElementById('mykadPassport').value,
  regnum: document.getElementById('regnum').value,
  contact: document.getElementById('contact').value,
  remark: remarkValue,      // kategori siap format
  reason: reasonFinal,      // sebab siap format
  tower: document.getElementById('tower').value,
  imageUrl: croppedImage    // gambar base64
};

const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 20000); // 20s
      
      try {
        const res = await fetch(urlCloudflareWorker, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(data),
  signal: controller.signal
});
        
        const respData = await res.json();
        clearTimeout(timeoutId);
    
        setSubmitBtnLoading(false);

        if (respData.success) {
          safeSwalFire({
            title: 'SUCCESS!',
            text: 'Data submitted!',
            icon: 'success',
            confirmButtonText: 'OK',
            background: 'linear-gradient(135deg,#e9f5e9,#fff,#d5ffe0)',
            color: '#176B39',
            width: 300,
            customClass: { popup: 'shadow-2xl px-7 pt-7 pb-6' },
            willOpen: (popup) => { popup.style.borderRadius = '14px'; },
            timer: 5000,
            timerProgressBar: true
          });

          document.getElementById("registrationForm").reset();
          document.getElementById('preview').src = "#";
          document.getElementById('imageContainer').style.display = 'none';
          document.getElementById('unitNumber').style.display = 'none';
          document.getElementById('otherCategory').style.display = 'none';
          document.getElementById('reasonSection').style.display = 'none';

          if (reasonSelect) {
            reasonSelect.style.color      = '#888888';
            reasonSelect.style.fontWeight = 'bold';
          }
        } else {
          safeSwalFire({
            title: 'ERROR!',
            text: 'Submit failed: ' + (respData.message || ''),
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      } catch (err) {
        clearTimeout(timeoutId);
        setSubmitBtnLoading(false);
        safeSwalFire({
          title: 'ERROR!',
          text: 'Error submit data: ' + err.message,
          icon: 'error',
          confirmButtonText: 'OK'
        });
      }
    });
  </script>
  
  <script>
    function pad(n){return n<10?'0'+n:n;}
    function updateDateTime() {
      const now = new Date();
      const d   = pad(now.getDate());
      const m   = pad(now.getMonth() + 1);
      const y   = now.getFullYear();
      const h   = pad(now.getHours());
      const min = pad(now.getMinutes());
      const s   = pad(now.getSeconds());
      document.getElementById("liveDateOnly").textContent = `${d}/${m}/${y}`;
      document.getElementById("liveTimeOnly").textContent = `${h}:${min}:${s}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();
  </script>
</body>
</html>
